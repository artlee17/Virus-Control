<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="data:application/manifest+json,{'name':'MidiControl','short_name':'Midi','start_url':'.','display':'standalone'}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MIDI Commander FIX</title>
    <style>
        :root { --accent: #00f2ff; --bg: #000; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .setup-bar { background: #222; padding: 15px; display: flex; gap: 10px; align-items: center; border-bottom: 2px solid var(--accent); }
        select { flex-grow: 1; background: #333; color: white; padding: 10px; border: none; }
        button { background: var(--accent); border: none; padding: 12px; font-weight: bold; border-radius: 5px; cursor: pointer; }
        
        .main-container { display: flex; flex: 1; padding: 10px; gap: 10px; }
        .faders { display: flex; flex: 0.4; justify-content: space-around; background: #111; padding: 10px; border-radius: 10px; }
        .fader-group { display: flex; flex-direction: column; align-items: center; }
        input[type=range] { appearance: slider-vertical; width: 40px; height: 150px; }
        
        .buttons { flex: 0.6; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; overflow-y: auto; }
        .midi-pad { background: #222; color: #888; border: none; height: 60px; font-size: 14px; font-weight: bold; border-radius: 5px; }
        .midi-pad.selected { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }

        #debug-box { background: #111; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; height: 80px; overflow-y: scroll; border-top: 1px solid #333; }
    </style>
</head>
<body>

<div class="setup-bar">
    <button id="btn-init">CONNECT</button>
    <select id="midi-out-select"><option>Tap Connect...</option></select>
</div>

<div class="main-container">
    <div class="faders">
        <div class="fader-group"><small>Pitch</small><input type="range" id="p-slid" min="0" max="127" value="64"><span id="p-val">64</span></div>
        <div class="fader-group"><small>Mod</small><input type="range" oninput="sendCC(1, this.value, 'm1')" min="0" max="127" value="0"><span id="m1">0</span></div>
        <div class="fader-group"><small>Rel</small><input type="range" oninput="sendCC(7, this.value, 'm2')" min="0" max="127" value="0"><span id="m2">0</span></div>
        <div class="fader-group"><small>Knob</small><input type="range" oninput="sendCC(30, this.value, 'm3')" min="0" max="127" value="0"><span id="m3">0</span></div>
    </div>

    <div class="buttons" id="btn-grid"></div>
</div>

<div id="debug-box">System Log Ready...</div>

<script>
    const logger = document.getElementById('debug-box');
    function log(m) { 
        logger.innerHTML += `<div>> ${m}</div>`;
        logger.scrollTop = logger.scrollHeight;
    }

    let midiOut = null;
    const presets = [
        "A1 First", "B74 Short", "B74 Long", "B3", "Indigo A84", "Virus A A18",
        "Piano", "Movie Strings", "Organ", "Atmo Reality", "Pad Exp", "Outer W",
        "Stellar", "Steel", "Riser", "Drone", "Key Cin", "NinthHvn", 
        "I Made This", "Space Brass", "Crystal"
    ];

    async function start() {
        log("Attempting MIDI access...");
        try {
            const midi = await navigator.requestMIDIAccess({ sysex: true });
            log("Access Granted!");
            
            const dropdown = document.getElementById('midi-out-select');
            const outputs = Array.from(midi.outputs.values());
            
            dropdown.innerHTML = "";
            outputs.forEach((out, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = out.name;
                dropdown.appendChild(opt);
                log("Found device: " + out.name);
            });

            midiOut = outputs[0];
            dropdown.onchange = (e) => { midiOut = outputs[e.target.value]; log("Selected: " + midiOut.name); };
            
            if(midiOut) log("Active Output: " + midiOut.name);

        } catch (e) {
            log("ERROR: " + e.message);
            if (location.protocol !== 'https:') log("CRITICAL: You MUST use HTTPS.");
        }
    }

    document.getElementById('btn-init').onclick = start;

    function sendCC(cc, val, label) {
        document.getElementById(label).innerText = val;
        if (midiOut) {
            midiOut.send([0xB2, cc, val]); // Ch 3
            log(`Sent CC ${cc} Val ${val}`);
        }
    }

    // Pitch logic
    const ps = document.getElementById('p-slid');
    ps.oninput = () => { 
        document.getElementById('p-val').innerText = ps.value;
        if(midiOut) midiOut.send([0xE2, 0, ps.value]); 
    };
    ps.onmouseup = ps.ontouchend = () => {
        ps.value = 64; document.getElementById('p-val').innerText = 64;
        if(midiOut) midiOut.send([0xE2, 0, 64]);
        log("Pitch Snapback");
    };

    // Build Grid
    const grid = document.getElementById('btn-grid');
    presets.forEach((name, i) => {
        const b = document.createElement('button');
        b.className = 'midi-pad';
        b.innerText = name;
        b.onclick = () => {
            document.querySelectorAll('.midi-pad').forEach(p => p.classList.remove('selected'));
            b.classList.add('selected');
            const val = (i === 18) ? 18 : (i === 19) ? 19 : (i === 20) ? 20 : i;
            if(midiOut) {
                midiOut.send([0xB2, 27, val]);
                log(`Sent CC 27 Val ${val}`);
            }
        };
        grid.appendChild(b);
    });

</script>
</body>
</html>
